#!/bin/bash
set -e

SCRIPTDIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )" # The directory of this script

source $SCRIPTDIR/update_vars.sh



cd $SCRIPTDIR/modules/terraform-aws-bastion

manifest="/modules/terraform-aws-bastion/modules/bastion-ami/manifest.json"
if [[ -f "$manifest" ]]; then
    export TF_VAR_centos7_ami="$(jq -r '.builds[] | select(.name == "centos7-ami") | .artifact_id' "$manifest" | tail -1 | cut -d ":" -f2)"
    echo "Found centos7_ami in manifest: TF_VAR_centos7_ami=$TF_VAR_centos7_ami"
    export TF_VAR_bastion_ami_id=$TF_VAR_centos7_ami
    echo "TF_VAR_bastion_ami_id=$TF_VAR_bastion_ami_id"
fi
terraform plan -out=tfplan -input=false -destroy
terraform apply -input=false tfplan

cd $SCRIPTDIR/modules/vault
terraform plan -out=tfplan -input=false -destroy
terraform apply -input=false tfplan
# terraform destroy --auto-approve -input=false $SCRIPTDIR/modules/vault # Destroy vault instances. Data is persisted to S3.

cd $SCRIPTDIR/modules/vpc
terraform plan -out=tfplan -input=false -destroy
terraform apply -input=false tfplan # Stop bastion hosts.