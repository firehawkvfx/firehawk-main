
- name: change hostname
  hostname:
    name: "{{ set_hostname }}"
  when: set_hostname is defined

- name: Update hosts file with regex if ubuntu to handle correctly.  Otherwise this https://github.com/ansible/ansible-modules-core/issues/2308
  lineinfile:
    dest: /etc/hosts
    line: "127.0.0.1       localhost       localhost.localdomain       {{ set_hostname }}"
    regexp: '^127\.0\.0\.1.*localhost.*'
    # regexp: "^127\.0\.0\.1.*localhost.*$"
  when: set_hostname is defined and ( ansible_distribution == 'Debian' or ansible_distribution == 'Ubuntu' )

- name: set preserve hostname in cloud.cfg
  lineinfile:
    dest: /etc/cloud/cloud.cfg
    line: "preserve_hostname: true"
    regexp: ".*preserve_hostname.*"
  when: set_hostname is defined and ( ansible_distribution == 'Debian' or ansible_distribution == 'Ubuntu' )

- name: Check registration of hostname
  shell: |
    dig deadlinedb.service.consul
  become: true
  args:
    executable: /bin/bash

- name: generate certs with vault for mongo db server
  shell: |
    export VAULT_ADDR=https://vault.service.consul:8200
    vault login -method=aws header_value=vault.service.consul role=provisioner-vault-role  
    vault write -format=json pki_int/issue/firehawkvfx-dot-com \
    common_name=deadlinedb.service.consul \
    ttl=8760h | tee \
    >(jq -r .data.certificate > /etc/ssl/mongodb_ca.pem) \
    >(jq -r .data.issuing_ca > /etc/ssl/mongodb_issuing_ca.pem) \
    >(jq -r .data.private_key > /etc/ssl/mongodb_ca_key.pem)
    cat /etc/ssl/mongodb_ca.pem /etc/ssl/mongodb_ca_key.pem > /etc/ssl/mongodb_consolidated_certs.pem
  become: true
  args:
    executable: /bin/bash

- name: generate certs with vault for mongo db client
  shell: |
    export VAULT_ADDR=https://vault.service.consul:8200
    vault login -method=aws header_value=vault.service.consul role=provisioner-vault-role  
    vault write -format=json pki_int/issue/firehawkvfx-dot-com \
    common_name=deadlinedb.service.consul \
    ttl=8760h | tee \
    >(jq -r .data.certificate > /etc/ssl/mongodbclient_ca.pem) \
    >(jq -r .data.issuing_ca > /etc/ssl/mongodbclient_issuing_ca.pem) \
    >(jq -r .data.private_key > /etc/ssl/mongodbclient_ca_key.pem)
    cat /etc/ssl/mongodbclient_ca.pem /etc/ssl/mongodbclient_ca_key.pem > /etc/ssl/mongodbclient_consolidated_certs.pem
  become: true
  args:
    executable: /bin/bash

- name: generate certs with vault for mongo db remote client
  shell: |
    export VAULT_ADDR=https://vault.service.consul:8200
    vault login -method=aws header_value=vault.service.consul role=provisioner-vault-role  
    vault write -format=json pki_int/issue/firehawkvfx-dot-com \
    common_name=deadlinedb.service.consul \
    ttl=8760h | tee \
    >(jq -r .data.certificate > /etc/ssl/mongodbremoteclient_ca.pem) \
    >(jq -r .data.issuing_ca > /etc/ssl/mongodbremoteclient_issuing_ca.pem) \
    >(jq -r .data.private_key > /etc/ssl/mongodbremoteclient_ca_key.pem)
    cat /etc/ssl/mongodbremoteclient_ca.pem /etc/ssl/mongodbremoteclient_ca_key.pem > /etc/ssl/mongodbremoteclient_consolidated_certs.pem
  become: true
  args:
    executable: /bin/bash

- name: download sources
  get_url:
    url: "https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-ubuntu1604-3.6.19.tgz"
    dest: "/tmp/mongodb-linux-x86_64-ubuntu1604-3.6.19.tgz"

- name: Create mongo app dir
  file: 
    path: /opt/Thinkbox/DeadlineDatabase10/mongo/application
    state: directory
  become: true

- name: Create mongo data dir
  file: 
    path: /opt/Thinkbox/DeadlineDatabase10/mongo/data
    state: directory
  become: true

- name: Extract
  unarchive:
    src: "/tmp/mongodb-linux-x86_64-ubuntu1604-3.6.19.tgz"
    dest: "/opt/Thinkbox/DeadlineDatabase10/mongo/application"
    extra_opts:
    - --strip-components=1 
    remote_src: true
  become: true

- name: Create mongo log dir
  file: 
    path: /opt/Thinkbox/DeadlineDatabase10/mongo/data/logs
    state: directory
  become: true

- name: mongodb service config file
  copy: 
    src: "config.conf"
    dest: "/opt/Thinkbox/DeadlineDatabase10/mongo/data/"
    mode: '0755'
  become: true

- name: deadline_mongo wrapper executable helper
  copy: 
    src: "deadline_mongo"
    dest: "/opt/Thinkbox/DeadlineDatabase10/mongo/application/bin"
    mode: '0755'
  become: true

- name: mongodb service
  copy: 
    src: "Deadline10db"
    dest: "/etc/init.d/"
    mode: '0755'
  become: true

- name: Start service mongodb Deadline10db
  service:
    name: Deadline10db
    state: started
    daemon_reload: true
    enabled: true
  become: true