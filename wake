#!/bin/bash
set -e

exit_if_error() {
  local exit_code=$1
  shift
  [[ $exit_code ]] &&               # do nothing if no error code passed
    ((exit_code != 0)) && {         # do nothing if error code is 0
      printf 'ERROR: %s\n' "$@" >&2 # we can use better logging here
      exit "$exit_code"             # we could also check to make sure
                                    # error code is numeric when passed
    }
}

SCRIPTDIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )" # The directory of this script

source $SCRIPTDIR/update_vars.sh

# Raise error if var isn't defined.
if [[ -z "$AWS_DEFAULT_REGION" ]]; then
    exit_if_error 1 "AWS_DEFAULT_REGION not defined."
fi
if [[ -z "$TF_VAR_bucket_extension" ]]; then
    exit_if_error 1 "TF_VAR_bucket_extension not defined."
fi

cd $SCRIPTDIR/modules/terraform-aws-iam-profile-provisioner
./generate-plan
terraform apply -input=false tfplan # Ensure Required Roles exist

cd $SCRIPTDIR/modules/terraform-aws-iam-profile-vault-client
./generate-plan
terraform apply -input=false tfplan # Ensure Required Roles exist

cd $SCRIPTDIR/modules/terraform-aws-iam-profile-openvpn
./generate-plan
terraform apply -input=false tfplan # Ensure Required Roles exist

cd $SCRIPTDIR/modules/terraform-aws-iam-profile-deadline-db
./generate-plan
terraform apply -input=false tfplan # Ensure Required Roles exist

cd $SCRIPTDIR/modules/vpc
./generate-plan
terraform apply -input=false tfplan # Ensure Main Vault VPC exists

cd $SCRIPTDIR/modules/terraform-aws-vpc-main-cloud9-peering
./generate-plan
terraform apply -input=false tfplan # Ensure VPC is peered with this cloud9 VPC

cd $SCRIPTDIR/modules/vault
./generate-plan
terraform apply -input=false tfplan # Ensure Vault / Consul instances are running, and configure VPC peering with the current cloud 9 VPC.

if [[ ! -f "/opt/consul/bin/run-consul" ]]; then
    echo "You have not yet installed consul."
    exit 0 # if the user hasn't installed consul yet, this step must be performed manually.
fi

echo "Running Consul..."
sudo /opt/consul/bin/run-consul --client --cluster-tag-key "${consul_cluster_tag_key}" --cluster-tag-value "${consul_cluster_tag_value}"

if [[ -z "$VAULT_TOKEN" ]]; then
    echo "Instances from this point require you to login to vault.  To avoid this message you can define the var VAULT_TOKEN"
fi

echo "Waiting for consul vault service..."
until consul catalog services | grep -m 1 "vault"; do sleep 1 ; done
until vault status | grep -m 1 "Initialized.*"; do sleep 1 ; done

initialised=true
vault status | grep -m 1 "Initialized.*true" || initialised=false

if [[ "$initialised" == false ]]; then
    echo "Vault is not Initialized.  Aborting. You will need to login and initialise the vault"
    exit 1
fi
sleep 3
echo "vault token lookup"

output=$(vault token lookup) && exit_status=0 || exit_status=$?
errors=$(echo "$output") | grep '^{' | jq -r .errors
echo "$output"
if [[ $exit_status -eq 0 && -z "$errors" ]]; then
    echo "$output"
else
    echo "...logging in. Or exit and use: vault login --no-print"
    vault login --no-print $VAULT_TOKEN
fi
vault token lookup

cd $SCRIPTDIR/modules/terraform-aws-bastion
./generate-plan
terraform apply -input=false tfplan
bastion_public_dns=$(terraform output public_dns)

cd $SCRIPTDIR/modules/terraform-aws-vault-client
./generate-plan
terraform apply -input=false tfplan
vault_client_consul_private_dns=$(terraform output consul_private_dns)

cd $SCRIPTDIR/modules/terraform-aws-vpn
./generate-plan
terraform apply -input=false tfplan

cd $SCRIPTDIR/modules/terraform-aws-vault-client
terraform output

printf "\nA private Vault client can be used to forward the Vault UI to your remote onsite web browser (address https://127.0.0.1:8200/ui) via the bastion by forwarding the web service. From your remote host, enable forwarding with:\n"
printf "ssh -J centos@${bastion_public_dns} centos@${vault_client_consul_private_dns} -L 8200:vault.service.consul:8200\n"